\section{Game Definitions}

In \cite{TIH} we can find a formalization of the Tetris game and a decisional/functional problem associated to it. Since the video game is played in finite board and a player can't win, the definition of the game introduces some variations to build a decisional problem.

In \cite{TT,TWFP,TCB,CTV,AVG} game variations are introduced without any formalization of the new emerging problems. We are going to provide a generalized Tetris game definition, following \cite{TIH}, which aims to include all possible game variations and the combination of these. 

A \emph{game} will refer to the hole game with its rules, configurations, pieces, ... and a \emph{match} will refer to a concrete Tetris game instance (the sequence of moves that a player would play). 

\begin{definition} \index{board}
  A \emph{board} \emph{B} is an $n$ by $m$ grid. Each cell $\cell$, $i = 1\dots n$, $j = 1\dots m$ is \emph{filled} or \emph{unfilled}.
\end{definition}

The board will be indexed from bottom to top and from left to right. The cell $\cell[1][1]$ is in the bottom left of the board and $\cell[n][m]$ is the top right-most cell.

In some results, the authors impose that the initial configuration must be constructible with the pieces and the rules of the game. This is that the initial configuration can be reached, with the game rules, from an empty board and with the appropriate pieces sequence. Others, the only condition that is imposed over the initial configuration is that it can't have filled rows. We will not impose the board to be constructible, (\textbf{NOTA:} no se com afegri-ho be). 
% # TODO: parlar de constructabilitat

\vspace{10px}

Tetris classical pieces are made up by attaching 4 squares. Using the definition form \cite{TT, WikiFandom} we generalize the piece definition.

\begin{definition} \index{$k$-omino} \index{polyomino}
  A \emph{polyomino} is a piece made up of unit squares joined edge to edge. A \emph{$k$-omino} is a polyomino made up with $k$ squares.
\end{definition}

For $k= 1,2,3,4,5, \dots$ the $k$-omino pieces are called respectively: \emph{monomino}, \emph{domino}, \emph{tromino}, \emph{tetromino}, \emph{pentomino}... The following defines sets of polyominoes.

\begin{definition} \index{$T_k$}
  $T_k$ is set of polyominoes containing all the possible $k$-ominoes and nothing else.
\end{definition}

\begin{example} The original video game uses the piece types $T_4 = \{ \ALL \}$, all the tetrominoes.
\end{example}

The following definition will be used to define the trajectory of a polyomino thought the board.

\begin{definition} \index{piece!state} \index{piece}
 A \emph{piece state} in a board $B$ is a tuple $ P = \piece$ where:
  \begin{itemize}
    \item $t \in T$, a polyomino.
    \item $\theta$ the \emph{orientation}, the number of degrees clockwise from the original piece. $ \theta \in \lbrace 0^\circ, 90^\circ, 180^\circ, 270^\circ \rbrace $.
    \item $\cell$ is the \emph{position} of the piece in $B$.
    \item  $f$ indicates if the piece is \emph{fixed} or \emph{unfixed} in B.
  \end{itemize}

  We will refer to a piece sate as \emph{piece}.
   
\end{definition}

In the most common versions of Tetris a polyomino is given to the player by placing it in the top-middle of the board, but others don't. For example in a variation called \texttheo{20-G}, the polyomino is paced int the top-middle of the board and moved maximally downward. In order to include all variations in the formalization, the initial position will be a computable function.

\begin{definition} \index{initial state}
  An \emph{initial state} is a computable function $\varphi$ that given a board $B$ and a polyomino $t$, outputs an unfixed piece state $$\varphi(B,t) = P_0 = \piece[t][\theta][i][j][\text{unfixed}].$$
\end{definition}

\begin{example} The initial state function that puts the piece at the top middle of the board without rotation is:
$$\varphi_0(B,t) = \piece[t][0^\circ][n][\lfloor m / 2 \rfloor][\text{unfixed}]$$

Where $n$ and $m$ are the board dimensions.

\end{example}


Notice that in our definition we only ask the piece state to be unfixed, the initial position and orientation are computed by the function. 

\vspace{10px}
\textbf{NOTA:} faig que la funcio inicial pugi colocar una peca en un lloc que estigui parcialment ocupat? (per exmple quan el taulell esta molt ple?), o fem que caigui "de mes amunt i la pugi colocar on vulgi", axio va lligat amb el "partial lock out rule", explicat mes endevant.
\vspace{10px}

As in all variations, the player moves the pieces one at a time, so only the piece that is moving has a state. This is because when a piece is fixed (reaches the \emph{fixed} state) it merges automatically with the board, and then the next piece starts in its initial state. In order to define how a piece moves thought the board, we need to define some moves for changing the piece state. 

\begin{definition} \index{move}
  A \emph{move} is a computable function $m$ that given a board $B$ and an unfixed piece $P = \piece[t][\theta][i][j][\text{unfixed}]$ outputs a new piece $m(B, P) = P'$. A move has a \emph{precondition} that needs to be satisfied before the piece is moved. The move is said to be \emph{legal} if the preconditions are satisfied. If preconditions aren't satisfied the move is said to be \emph{illegal}.
\end{definition}

Some variations consist on changing the set of  moves available in a match, so we are not imposing any condition over this set. We present the most common move functions:

\begin{itemize}
  \item $r_+$ a \emph{clockwise rotation:} if the rotated piece does not overlap with an occupied cell of the board, the output is 
    $$r_+ (B, \piece[t][\theta][i][j][\text{unfixed}]) = \piece[t][\theta + 90^\circ][i][j][\text{unfixed}]$$

  \item $r_-$ a \emph{counterclockwise rotation:} the same but counterclockwise rotation. 

  \item $s_l$ a \emph{slide to the left:} if all the board cells adjacent to de left of the piece are not occupied, the output is:
    $$s_l (B, \piece[t][\theta][i][j][\text{unfixed}]) = \piece[t][\theta][i][j-1][\text{unfixed}]$$
  \item $s_r$ a \emph{slide to the right:} analogous to the slide to the left.

  \item $d$ a \emph{drop by one row:} if all the board cells bellow the piece are not occupied the output is:
    $$d (B, \piece[t][\theta][i][j][\text{unfixed}]) = \piece[t][\theta][i-1][j][\text{unfixed}]$$

  \item $f$ a \emph{fix:} if any of the board cells bellow the piece is occupied, the output is:
    $$f (B, \piece[t][\theta][i][j][\text{unfixed}]) = \piece[t][\theta][i][j][\text{fixed}]$$

  \item $hd$ a \emph{hard drop:} the piece is moved maximally downwards and fixed.
    
\end{itemize}

All the conditions can be computed in $\mathcal{O}(1)$, because only a constant numbers of cells are need to be visited every time. 

\vspace{10px}

\textbf{NOTA/Observations:} The above definitions are quite ambiguous, and some game variations change some small details in order to prove their results. For example, there is no unique way of rotating a piece in most situations, for example the $\II$ piece. The following details this small changes.

The \emph{lock out/partial lock rule} involves the fix move preconditions. The \emph{lock out rule} states that if any "square" of the piece is outside the board, the piece cannot be fixed. In contraposition, the \emph{partial lock out rule} states that if any of the "squares" of a piece is inside the board, the piece can be fixed. By default, we will use the \emph{lock out rule}.
  
The rotation moves, $r_+$ and $r_-$, are also  ambiguous, since some pieces don't have a unique rotation. A pair of two rotation moves is called a \emph{rotation model}. A rotation model is called \emph{reasonable} if, intuitively, the model simply allows for the turning of a piece on the board without
any unnatural powers of translation, such as "jumping" to a distant point in the board. The simplest (reasonable) rotation model rotates a piece from its center (the piece state position), if the rotated piece doesn't overlap with any piece it outputs the new piece state.  

An extended rotation model from this one is the Super Rotation System, also reasonable. This model, after rotating a piece, tries shot translations if the rotated piece overlaps with some occupied cell. If any of the translations leaves the piece in a unfilled positon, the model outputs this new piece state.

\vspace{10px}
Let's now define the \emph{trajectory} of a piece type in a Tetris game. Intuitively the trajectory starts when the piece is given to the player, continues with a sequence of legal moves and ends when the piece is fixed. 

\begin{definition} \index{trajectory}
  Let $B$ be a board, $t$ a polyomino and $\varphi$ an initial state. Let $P_0 = \varphi(B,t)$ be the initial state of the polyomino $t$. Then a sequence of $k$ moves $\sigma = (m_1, ..., m_k)$ is a \emph{trajectory} for $t$ if:

 \begin{itemize}
   \item the move $m_{i}$ over $P_{i-1}$ is a legal move for all $i = 1 \dots k$
  \item and $P_k$ is fixed.
 \end{itemize}
 
 Where $P_{i+1} = m_{i+1}(B,P_i)$ is the piece stat in $B$ after $i$ moves.
\end{definition}

In our game there is no notion for time, and pieces aren't dropped by one row after some amount of time, so the number of moves in a trajectory is not limited. For example the player can rotate the piece clockwise indefinitely. We can fix this by limiting the number of moves by some constant $\mathcal{O}(n \cdot m)$, that lets the player place the piece anywhere on the board.

One of the most characteristic thing about Tetris is rows clearing. After we fix a piece the game clears the filled rows. With a board and a trajectory we need to define how we merge both. 

\begin{definition} \index{merged game board}
  Given a board $B$ and trajectory $\sigma = (m_1, ..., m_k)$ of a given piece type $t$ the \emph{merged game board} $B'$ is defined as follows:
  \begin{enumerate}
    \item $B'$ is initially $B$.
    \item The cells of $B$ corresponding to the last piece state of the trajectory are filled in $B'$.
    \item For every filled row $r$ of $B'$:
      \begin{enumerate}
        \item Replace each row $r' \geq r$ by $r'+1$.
        \item Clear (set all cells to unfilled) of row $m$.
      \end{enumerate}
  \end{enumerate}
\end{definition}

We have now all the components of a Tetris match.

\begin{definition} \index{match}
  Given a board $B$ and a sequence of $k$ polyominoes $P = (t_1,\dots,t_k)$ a \emph{match} $\Sigma$ is a sequence
  $$ B = B_0, \sigma_1, B_1, \sigma_2, B_2, \dots  \sigma_q, B_q, \; \; q \leq k$$ 
  where:
  \begin{itemize}
    \item $\sigma_i$ is a trajectory of the piece type $t_i$ in the board $B_{i-1}$.
    \item $B_{i+1}$ is the merged board from $B_i$ and $\sigma_i$.
    \item $q < k$ iff doesn't exist any trajectory $\sigma_{q+1}$ from de board $B_q$ with the piece type $t_{q+1}$. In this case we say the game is a \emph{loss}.
  \end{itemize}
\end{definition}

The third condition, $q < k$ happens when the player cannot apply any move to the piece, because any precondition is satisfied (this would typically whappen when the board is filled and the initial state puts the piece in an occupied cell).

\section{Problem}

All the problems share the same formulation. Given a set of polyominoes T, a.,The \textsc{Tetirs} problem is:

\begin{definition}[\textsc{Tetris}] \index{\textsc{Tetris}}
  Given: 
  \begin{itemize}
    \item $D \subset \mathbb{N} \times \mathbb{N}$ a set of board dimensions.
    \item a set of polyominoes $T$
    \item an initial state function $\varphi$
    \item a set of moves $M$
    \item objective fucntion $\Phi$
  \end{itemize}
    the problem $\textsc{Tetris}[D,T,\varphi,M,\Phi]$ is as follows:
  
  \begin{itemize}
    \item \textbf{Input}: $\mathcal{G} = (B,(t_1,\dots,t_k))$ an initial board $B$ with dimension in $D$ and a sequence of $k$ polyominoes, where $t_i \in T$ for $i = 1,\dots,k$.
    
    \item \textbf{Output} : Does exist a match $\Sigma$, with initial function $\varphi$ and moves $M$, such that $\Phi ( \mathcal{G}, \Sigma )$ holds? 
  \end{itemize}


\end{definition}

An objective function $\Phi(\mathcal{G},\Sigma)$ is computable \emph{checkable and acyclic} if it takes only into account the final state of the pieces, ignoring the piece trajectory. The following are objective functions:

\begin{itemize}
  \item \texttheo{k-cleared-rows}: in the game $\mathcal{G}$, does $\sigma$ clear at least $k$ rows?
  \item \texttheo{k-tetrises}: in the game $\mathcal{G}$, does $\sigma$ contain at least $k$ tetrises?
  \item \texttheo{h-height-filled}: in the game $\mathcal{G}$, does $\sigma$ never fill a cell above height $h$?
  \item \texttheo{p-placed-pices}: in the game $\mathcal{G}$, does $\sigma$ place at least $p$ pieces before losing.
\end{itemize} 

The two most popular variations are:

\begin{itemize} \index{\clearing} \index{\survival}
  \item \clearing: in the game $\mathcal{G}$, does $\sigma$ leave every cell of the board unfilled?
  \item \survival: is equivalent to \texttheo{n-height-filled}, where $n$ is the height of board $B$. This is finding a sequence $\Sigma$ that is not a loss.
\end{itemize}

